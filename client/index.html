<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AuraScan - Biometric Identity</title>
    
    <!-- Fonts: Inter for UI, JetBrains Mono for Data -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        'glass': 'rgba(255, 255, 255, 0.05)',
                        'glass-border': 'rgba(255, 255, 255, 0.1)',
                        'accent': '#8b5cf6',
                        'success': '#10b981',
                        'warning': '#f59e0b',
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'scan-vertical': 'scan 2s linear infinite',
                    },
                    keyframes: {
                        scan: {
                            '0%': { transform: 'translateY(-100%)' },
                            '100%': { transform: 'translateY(100%)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- TensorFlow.js & BlazeFace -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>

    <style>
        html, body, #root { 
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; 
            background-color: #030305; color: #fff;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Noise Texture for Premium Feel */
        .bg-noise {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            pointer-events: none; z-index: 1;
        }
        
        /* Glassmorphism Utilities */
        .glass-panel {
            background: rgba(20, 20, 25, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <div class="bg-noise"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useMemo } = React;

        // --- ICONS (Refined for Tech feel) ---
        const Icon = ({ p, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{p}</svg>
        );
        
        const Icons = {
            Camera: (p) => <Icon {...p} p={<><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></>} />,
            Upload: (p) => <Icon {...p} p={<><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></>} />,
            Refresh: (p) => <Icon {...p} p={<><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></>} />,
            Share: (p) => <Icon {...p} p={<><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></>} />,
            Scan: (p) => <Icon {...p} p={<><path d="M12 3a9 9 0 1 0 9 9"/><path d="M12 3v9"/></>} />, 
            Hexagon: (p) => <Icon {...p} p={<path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>} />,
            Activity: (p) => <Icon {...p} p={<polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>} />,
            Shield: (p) => <Icon {...p} p={<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>} />,
            Alert: (p) => <Icon {...p} p={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>} />,
            X: (p) => <Icon {...p} p={<><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>} />,
            Check: (p) => <Icon {...p} p={<polyline points="20 6 9 17 4 12"/>} />,
            Settings: (p) => <Icon {...p} p={<><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></>} />,
            ChevronDown: (p) => <Icon {...p} p={<path d="m6 9 6 6 6-6"/>} />,
            Cpu: (p) => <Icon {...p} p={<rect x="4" y="4" width="16" height="16" rx="2" />} />,
            Zap: (p) => <Icon {...p} p={<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>} />,
            Sparkles: (p) => <Icon {...p} p={<><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 5H5"/><path d="M6 17v4"/><path d="M4 19h4"/></>} />,
            EyeOff: (p) => <Icon {...p} p={<><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></>} />
        };

        const AURA_CONFIG = {
            "Mystic Violet": { color: "#8b5cf6", gradient: "from-violet-900 to-fuchsia-900", desc: "Rare & Visionary" },
            "Golden Hour":   { color: "#f59e0b", gradient: "from-amber-900 to-yellow-900", desc: "Radiant & Warm" },
            "Cyber Blue":    { color: "#3b82f6", gradient: "from-blue-900 to-cyan-900", desc: "Calm & Analytical" },
            "Inferno Red":   { color: "#ef4444", gradient: "from-red-900 to-orange-900", desc: "Bold & Energetic" },
            "Forest Calm":   { color: "#10b981", gradient: "from-emerald-900 to-green-900", desc: "Grounded & Growth" },
            "Neon Pink":     { color: "#ec4899", gradient: "from-pink-900 to-rose-900", desc: "Playful & Magnetic" },
        };

        // --- UTILS ---
        const RadarChart = ({ data, size = 150 }) => {
            const center = size / 2;
            const radius = (size / 2) - 10;
            const angleSlice = (Math.PI * 2) / data.length;

            const getPoint = (value, index) => {
                const angle = index * angleSlice - Math.PI / 2;
                return {
                    x: center + (radius * (value / 100)) * Math.cos(angle),
                    y: center + (radius * (value / 100)) * Math.sin(angle)
                };
            };

            const points = data.map((d, i) => getPoint(d.value, i));
            const pathData = points.map((p, i) => (i === 0 ? 'M' : 'L') + `${p.x},${p.y}`).join(' ') + 'Z';
            const bgPoints = data.map((d, i) => getPoint(100, i));
            const bgPath = bgPoints.map((p, i) => (i === 0 ? 'M' : 'L') + `${p.x},${p.y}`).join(' ') + 'Z';

            return (
                <svg width={size} height={size} className="overflow-visible">
                    <path d={bgPath} fill="none" stroke="rgba(255,255,255,0.1)" strokeWidth="1" />
                    <path d={points.map((p, i) => (i === 0 ? 'M' : 'L') + `${getPoint(50, i).x},${getPoint(50, i).y}`).join(' ') + 'Z'} fill="none" stroke="rgba(255,255,255,0.05)" strokeWidth="1" strokeDasharray="4 2"/>
                    <path d={pathData} fill="rgba(139, 92, 246, 0.3)" stroke="#8b5cf6" strokeWidth="2" className="drop-shadow-[0_0_10px_rgba(139,92,246,0.5)]"/>
                    {points.map((p, i) => (
                        <g key={i}>
                            <circle cx={p.x} cy={p.y} r="3" fill="#fff" />
                            <text x={p.x} y={p.y} 
                                  dx={p.x > center ? 10 : -10} 
                                  dy={p.y > center ? 10 : -10} 
                                  textAnchor={p.x > center ? "start" : "end"} 
                                  fill="#94a3b8" 
                                  fontSize="9" 
                                  className="font-mono uppercase tracking-widest">
                                {data[i].label}
                            </text>
                        </g>
                    ))}
                </svg>
            );
        };

        const calculateAestheticScore = (metrics, technical) => {
            let rawScore = 
                ((metrics.symmetry * 2.0) + (metrics.ratios * 2.0)) + 
                ((metrics.skin_clarity * 1.5) + (metrics.skin_texture * 1.5)) + 
                ((metrics.feature_definition * 2.0) + (metrics.vitality * 1.0)); 

            const blurPenalty = technical.blur_level * 3; 
            const lightingPenalty = Math.max(0, (7 - technical.lighting_quality) * 3); 
            
            let penalty = blurPenalty + lightingPenalty;
            let finalScore = Math.max(10, rawScore - penalty);

            if (finalScore > 50) {
                if (finalScore > 80) finalScore = 80 + ((finalScore - 80) * 0.6); 
            }

            let confidence = 100 - (technical.blur_level * 10) - (Math.max(0, 10 - technical.lighting_quality) * 5);
            
            return {
                score: Math.round(finalScore),
                confidence: Math.round(Math.max(10, Math.min(100, confidence))),
                penalties: { blur: blurPenalty, lighting: lightingPenalty }
            };
        };

        const getAuraFromScore = (score) => {
            if (score >= 90) return "Mystic Violet";
            if (score >= 82) return "Golden Hour";
            if (score >= 74) return "Cyber Blue";
            if (score >= 60) return "Forest Calm";
            if (score >= 50) return "Neon Pink";
            return "Inferno Red";
        }

        // --- API & SIMULATION ---
        
        const resizeImage = (base64Str, maxWidth = 800) => {
            return new Promise((resolve) => {
                let img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    let canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                    canvas.width = width; canvas.height = height;
                    let ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.85)); 
                };
            });
        };

        const generateFakeAnalysis = (imageSrc) => {
            let hash = 0;
            for (let i = 0; i < imageSrc.length; i++) hash = ((hash << 5) - hash) + imageSrc.charCodeAt(i);
            const pH = Math.abs(hash);
            const base = (pH % 45) + 40; 
            
            return {
                success: true,
                score: base,
                confidence: 100, 
                aura: Object.keys(AURA_CONFIG)[pH % 6],
                core: [
                    { label: "SYM", value: Math.min(99, base + (pH%10)) },
                    { label: "SKIN", value: Math.min(99, base - 5 + (pH%15)) },
                    { label: "RATIO", value: Math.min(99, base + 5) },
                    { label: "DEF", value: Math.min(99, base + (pH%8)) },
                    { label: "VIT", value: Math.min(99, base - (pH%10)) },
                ],
                advanced: {
                    age: 20 + (pH % 15),
                    skinType: "Normal",
                    eyeShape: "Almond",
                    faceShape: "Oval",
                    jawType: "Defined",
                    suggestion: "Simulation Mode: Results are randomized based on image hash.",
                    improvements: [
                        "Ensure even lighting to highlight facial symmetry.",
                        "Maintain skin hydration for better texture analysis.",
                        "Groom eyebrows to frame the face effectively.",
                        "Experiment with angles to find your best side.",
                        "Consistent skincare routine improves clarity score."
                    ]
                },
                technical: {
                    blur: 0,
                    lighting: 8,
                    angle: 0
                },
                comment: "Biometric simulation complete. No API connection."
            };
        };

        async function analyzeImageWithGemini(base64Image, backendUrl) {
            try {
                const resizedBase64 = await resizeImage(base64Image);
                
                // Connect to the user-specified backend
                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        image: resizedBase64
                    })
                });

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    // Log real network error for debugging
                    console.error("Server Error:", errData);
                    throw new Error(errData.error || "Server Connection Failed");
                }

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) throw new Error("NO_DATA_FROM_AI");
                
                const parsed = JSON.parse(text.replace(/```json/g, '').replace(/```/g, '').trim());
                
                if (parsed.inspection.verdict !== 'good_for_analysis') {
                    return { error: parsed.inspection.reason, inspection: parsed.inspection };
                }

                const technical = {
                    blur_level: parsed.inspection.blur_level,
                    lighting_quality: parsed.inspection.lighting_score,
                    angle_yaw: 0
                };

                const calc = calculateAestheticScore(parsed.metrics, technical);
                
                return {
                    success: true,
                    score: calc.score,
                    confidence: calc.confidence,
                    aura: getAuraFromScore(calc.score),
                    core: [
                        { label: "SYM", value: parsed.metrics.symmetry * 10 },
                        { label: "SKIN", value: ((parsed.metrics.skin_clarity + parsed.metrics.skin_texture)/2) * 10 },
                        { label: "RATIO", value: parsed.metrics.ratios * 10 },
                        { label: "DEF", value: parsed.metrics.feature_definition * 10 },
                        { label: "VIT", value: parsed.metrics.vitality * 10 },
                    ],
                    advanced: {
                        age: parsed.demographics.age_visual,
                        skinType: parsed.features.skin_type || "Unknown",
                        eyeShape: parsed.features.eye_shape || "Unknown",
                        faceShape: parsed.features.face_shape || "Unknown",
                        jawType: parsed.features.jaw_type || "Unknown",
                        suggestion: parsed.comment,
                        improvements: parsed.improvements || []
                    },
                    technical: {
                        blur: parsed.inspection.blur_level,
                        lighting: parsed.inspection.lighting_score,
                        angle: 0
                    },
                    comment: parsed.comment
                };

            } catch (error) {
                console.error("Fetch Error:", error);
                return { error: error.message, isNetworkError: true };
            }
        }

        // --- COMPONENTS ---

        const ScanningOverlay = ({ progress }) => (
            <div className="absolute inset-0 z-50 bg-black/80 backdrop-blur-sm flex flex-col items-center justify-center font-mono">
                <div className="relative w-64 h-64 border border-white/10 rounded-full flex items-center justify-center">
                    <div className="absolute inset-0 border-t-2 border-accent rounded-full animate-spin"></div>
                    <div className="absolute inset-4 border-b-2 border-white/20 rounded-full animate-spin" style={{animationDirection: 'reverse', animationDuration: '3s'}}></div>
                    <div className="text-4xl font-bold tracking-tighter text-white">{progress}%</div>
                </div>
                <div className="mt-8 space-y-1 text-center">
                    <div className="text-xs text-accent uppercase tracking-widest animate-pulse">
                        {progress < 30 ? "ACQUIRING BIOMETRICS" : progress < 60 ? "MAPPING TOPOLOGY" : "CALCULATING INDEX"}
                    </div>
                    <div className="text-[10px] text-slate-500">AuraScan v2.4.1 Processing</div>
                </div>
                <div className="absolute bottom-10 w-full px-10 flex justify-between text-[10px] text-slate-600 font-mono">
                    <span>CPU: {(progress * 0.8).toFixed(1)}%</span>
                    <span>MEM: {120 + progress}MB</span>
                </div>
            </div>
        );

        const ResultCard = ({ label, value, subtext, highlight = false }) => (
            <div className={`relative overflow-hidden rounded-xl border p-4 flex flex-col items-center justify-center text-center transition-all ${highlight ? 'bg-white/5 border-accent/50 shadow-[0_0_15px_rgba(139,92,246,0.15)]' : 'bg-black/40 border-white/10'}`}>
                <span className="text-[9px] font-bold text-slate-400 uppercase tracking-widest mb-1">{label}</span>
                <span className={`text-sm sm:text-xl font-sans font-bold leading-snug w-full break-words ${highlight ? 'text-white' : 'text-slate-200'}`}>
                    {value}
                </span>
                {subtext && <span className="text-[9px] text-slate-500 mt-1">{subtext}</span>}
            </div>
        );

        const TechnicalBar = ({ label, value, max = 10, inverse = false }) => {
            const percentage = (value / max) * 100;
            let color = 'bg-accent';
            if (inverse) {
                color = percentage < 30 ? 'bg-success' : percentage < 60 ? 'bg-warning' : 'bg-red-500';
            } else {
                color = percentage > 70 ? 'bg-success' : percentage > 40 ? 'bg-warning' : 'bg-red-500';
            }

            return (
                <div className="flex items-center gap-2 text-[10px] font-mono text-slate-400">
                    <span className="w-16 uppercase">{label}</span>
                    <div className="flex-1 h-1.5 bg-white/10 rounded-full overflow-hidden">
                        <div className={`h-full rounded-full transition-all duration-500 ${color}`} style={{ width: `${percentage}%` }}></div>
                    </div>
                    <span className="w-6 text-right">{value}</span>
                </div>
            );
        };

        const MainApp = () => {
            const [image, setImage] = useState(null);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [result, setResult] = useState(null);
            const [error, setError] = useState(null);
            const [showCamera, setShowCamera] = useState(false);
            const [scanProgress, setScanProgress] = useState(0);
            // DEFAULT TO LOCALHOST
            const [backendUrl, setBackendUrl] = useState("http://localhost:3000/api/analyze");
            const [showSettings, setShowSettings] = useState(false);
            const [model, setModel] = useState(null);
            const [isModelLoading, setIsModelLoading] = useState(true);
            
            // Tracks if the last successful scan was real AI
            const [lastScanWasAI, setLastScanWasAI] = useState(false);

            const videoRef = useRef(null);
            const canvasRef = useRef(null);

            useEffect(() => {
                const load = async () => {
                    try { setModel(await blazeface.load()); } 
                    catch(e) { console.log("Blazeface load error"); }
                    setIsModelLoading(false);
                };
                load();
            }, []);

            const startAnalysis = async () => {
                setIsAnalyzing(true);
                setError(null);
                
                let p = 0;
                const interval = setInterval(() => { p = (p+1)%100; setScanProgress(p); }, 30);

                if (model) {
                    const imgEl = new Image();
                    imgEl.src = image;
                    await imgEl.decode();
                    const preds = await model.estimateFaces(imgEl, false);
                    if (!preds || preds.length === 0) {
                        clearInterval(interval); setIsAnalyzing(false);
                        setError("No face detected. Please center your face.");
                        return;
                    }
                }

                const data = await analyzeImageWithGemini(image, backendUrl);
                clearInterval(interval);
                setIsAnalyzing(false);

                if (data && data.success) {
                    setResult(data);
                    setLastScanWasAI(true);
                } else if (data && data.error) {
                    if (data.isNetworkError) {
                        const fake = generateFakeAnalysis(image);
                        fake.comment = "Simulated Mode (Network Unavailable)";
                        setResult(fake);
                        setLastScanWasAI(false); // Explicitly set to false
                    } else {
                        setError(data.error); 
                    }
                }
            };

            const capture = () => {
                const v = videoRef.current;
                const c = canvasRef.current;
                if(v && c) {
                    c.width = v.videoWidth; c.height = v.videoHeight;
                    c.getContext('2d').drawImage(v, 0, 0);
                    setImage(c.toDataURL('image/jpeg'));
                    setShowCamera(false);
                    v.srcObject.getTracks().forEach(t => t.stop());
                }
            };

            const auraData = result ? AURA_CONFIG[result.aura] : null;

            // REACTIVE STATUS LOGIC
            const getStatusLabel = () => {
                if (isModelLoading) return { text: "INIT...", color: "text-slate-400", bg: "bg-slate-800" };
                
                // If we have a result, show based on that result
                if (result) {
                    if (lastScanWasAI) {
                         return { text: "AI ANALYSIS", color: "text-emerald-400", bg: "bg-emerald-900/20 border-emerald-500/20" };
                    } else {
                         return { text: "OFFLINE MODE", color: "text-amber-400", bg: "bg-amber-900/20 border-amber-500/20" };
                    }
                }

                // Idle State - We don't claim AI Online until we prove it
                return { text: "SYSTEM READY", color: "text-slate-400", bg: "bg-white/5 border-white/10" };
            };

            const status = getStatusLabel();

            return (
                <div className="relative flex flex-col h-full font-sans select-none">
                    
                    <header className="z-30 shrink-0 px-6 py-4 flex justify-between items-center backdrop-blur-md border-b border-white/5 bg-black/20">
                        <div className="flex items-center gap-2">
                            <Icons.Hexagon className="w-5 h-5 text-accent" />
                            <span className="font-bold tracking-widest text-sm text-white">AURASCAN</span>
                        </div>
                        <div className="flex items-center gap-3">
                            <button onClick={() => setShowSettings(!showSettings)} className="text-slate-400 hover:text-white transition-colors">
                                <Icons.Settings className="w-5 h-5" />
                            </button>
                            <div className={`text-[10px] font-mono px-2 py-1 rounded border flex gap-1 items-center ${status.bg} ${status.color}`}>
                                <div className={`w-1.5 h-1.5 rounded-full ${status.text.includes("OFFLINE") ? 'bg-amber-400' : status.text.includes("AI") ? 'bg-emerald-400 animate-pulse' : 'bg-slate-400'}`}></div>
                                {status.text}
                            </div>
                        </div>
                    </header>

                    {showSettings && (
                        <div className="absolute inset-0 z-50 flex items-start justify-center pt-20 px-4 bg-black/60 backdrop-blur-sm animate-in fade-in">
                            <div className="w-full max-w-sm glass-panel rounded-2xl p-6 shadow-2xl">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-sm font-bold uppercase tracking-wider text-slate-300">Network Config</h3>
                                    <button onClick={() => setShowSettings(false)}><Icons.X className="w-5 h-5 text-slate-400"/></button>
                                </div>
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-[10px] font-mono text-slate-500 uppercase block mb-1">Backend Server URL</label>
                                        <input 
                                            type="text" 
                                            value={backendUrl} 
                                            onChange={(e) => setBackendUrl(e.target.value)}
                                            placeholder="http://localhost:3000/api/analyze"
                                            className="w-full bg-black/50 border border-white/10 rounded-lg px-3 py-2 text-xs font-mono text-white focus:border-accent focus:outline-none focus:ring-1 focus:ring-accent placeholder-slate-600"
                                        />
                                        <p className="text-[9px] text-slate-500 mt-2">
                                            If testing on mobile, replace "localhost" with your PC's IP address (e.g., http://192.168.1.5:3000/api/analyze).
                                        </p>
                                    </div>
                                    <button onClick={() => setShowSettings(false)} className="w-full py-2 bg-accent hover:bg-violet-600 text-white rounded-lg text-xs font-bold uppercase tracking-wider transition-colors">
                                        Save Configuration
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Main Content Area */}
                    <main className="flex-1 relative overflow-hidden flex flex-col z-10">
                        
                        {/* CAMERA VIEW */}
                        {showCamera && (
                            <div className="absolute inset-0 bg-black z-50 flex flex-col">
                                <video ref={videoRef} autoPlay playsInline className="flex-1 object-cover transform scale-x-[-1]" />
                                <canvas ref={canvasRef} className="hidden" />
                                <div className="h-24 flex items-center justify-center gap-10 bg-black/90 backdrop-blur">
                                    <button onClick={() => setShowCamera(false)} className="p-4 bg-white/10 rounded-full text-white hover:bg-white/20"><Icons.X/></button>
                                    <button onClick={capture} className="w-16 h-16 bg-white rounded-full border-4 border-slate-300 hover:scale-105 transition-transform"></button>
                                    <div className="w-12"></div>
                                </div>
                            </div>
                        )}

                        {image ? (
                            <div className="relative flex-1 flex flex-col w-full h-full">
                                
                                {/* Background Image (Blurred for ambiance) */}
                                <div className="absolute inset-0 z-0 overflow-hidden">
                                    <img src={image} className="w-full h-full object-cover opacity-30 blur-3xl scale-125" />
                                    <div className="absolute inset-0 bg-gradient-to-b from-black/80 via-black/90 to-black"></div>
                                </div>

                                {/* Preview Image (Visible before scan) */}
                                {!result && !isAnalyzing && !error && (
                                    <div className="absolute inset-0 z-10 flex items-center justify-center p-6 pb-28">
                                        <img src={image} className="w-full h-full object-contain rounded-lg shadow-2xl" />
                                    </div>
                                )}

                                {/* Active Analysis Overlay */}
                                {isAnalyzing && <ScanningOverlay progress={scanProgress} />}

                                {/* Strict Error Display */}
                                {error && !isAnalyzing && (
                                    <div className="absolute inset-0 z-40 flex flex-col items-center justify-center p-8 text-center animate-in zoom-in">
                                        <div className="w-20 h-20 bg-red-500/10 rounded-full flex items-center justify-center mb-6 border border-red-500/20">
                                            <Icons.EyeOff className="w-8 h-8 text-red-500" />
                                        </div>
                                        <h2 className="text-xl font-bold text-white mb-2">Scan Rejected</h2>
                                        <p className="text-sm text-red-200/80 mb-8 max-w-xs leading-relaxed bg-red-900/20 p-3 rounded-lg border border-red-500/20">{error}</p>
                                        <button onClick={() => {setImage(null); setError(null);}} className="px-6 py-3 bg-white text-black font-bold rounded-lg text-xs uppercase tracking-wider flex items-center gap-2">
                                            <Icons.Refresh className="w-4 h-4"/> Retake Photo
                                        </button>
                                    </div>
                                )}

                                {/* Results View */}
                                {result && !isAnalyzing && (
                                    <div className="relative z-10 flex flex-col h-full animate-in fade-in duration-700">
                                        
                                        {/* Scrollable Content */}
                                        <div className="flex-1 overflow-y-auto no-scrollbar pb-32">
                                            
                                            {/* Header Section */}
                                            <div className="pt-8 px-6 text-center">
                                                <div className={`inline-flex items-center gap-2 px-3 py-1 rounded-full border text-[10px] font-bold uppercase tracking-widest mb-4 bg-gradient-to-r ${auraData?.gradient} border-white/10`}>
                                                    <Icons.Sparkles className="w-3 h-3 text-white" />
                                                    {result.aura}
                                                </div>
                                                
                                                <div className="flex items-baseline justify-center gap-1 mb-2">
                                                    <span className="text-7xl font-bold text-white tracking-tighter drop-shadow-2xl">
                                                        {result.score}
                                                    </span>
                                                    <span className="text-xl text-slate-500 font-mono">/100</span>
                                                </div>
                                                
                                                <p className="text-sm text-slate-400 font-medium max-w-xs mx-auto">
                                                    Biometric Index Calculated
                                                </p>
                                            </div>

                                            {/* Main Visualization (Radar) */}
                                            <div className="flex justify-center py-6">
                                                <div className="relative">
                                                    <RadarChart data={result.core} size={220} />
                                                    {/* Central Glow */}
                                                    <div className="absolute inset-0 bg-accent/20 blur-3xl rounded-full -z-10"></div>
                                                </div>
                                            </div>

                                            {/* Insights Section */}
                                            <div className="px-6 space-y-4">
                                                
                                                {/* Biometric Profile (Features) */}
                                                <div>
                                                    <h3 className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 pl-1">Biometric Profile</h3>
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <ResultCard label="Face Shape" value={result.advanced.faceShape} />
                                                        <ResultCard label="Eye Shape" value={result.advanced.eyeShape} />
                                                        <ResultCard label="Skin Type" value={result.advanced.skinType} />
                                                        <ResultCard label="Jaw Structure" value={result.advanced.jawType} />
                                                    </div>
                                                </div>

                                                {/* Top Level Stats */}
                                                <div className="grid grid-cols-2 gap-3 mt-2">
                                                    <ResultCard label="Visual Age" value={result.advanced.age} highlight={false} />
                                                    <ResultCard label="Confidence" value={`${result.confidence}%`} highlight={result.confidence > 80} />
                                                </div>

                                                {/* Technical Breakdown */}
                                                <div className="bg-black/20 rounded-xl p-4 border border-white/5 space-y-2">
                                                    <h3 className="text-[9px] font-bold text-slate-500 uppercase tracking-widest mb-2">Technical Inspection</h3>
                                                    <TechnicalBar label="Sharpness" value={10 - result.technical.blur} max={10} />
                                                    <TechnicalBar label="Lighting" value={result.technical.lighting} max={10} />
                                                </div>

                                                {/* AI Comment */}
                                                <div className="glass-panel rounded-xl p-5 border-l-4 border-l-accent">
                                                    <div className="flex items-center gap-2 mb-2">
                                                        <Icons.Cpu className="w-4 h-4 text-accent" />
                                                        <span className="text-[10px] font-bold uppercase text-slate-400 tracking-wider">System Analysis</span>
                                                    </div>
                                                    <p className="text-sm text-slate-200 italic leading-relaxed">
                                                        "{result.comment}"
                                                    </p>
                                                </div>

                                                {/* Improvement Protocol */}
                                                {result.advanced.improvements && result.advanced.improvements.length > 0 && (
                                                    <div className="glass-panel rounded-xl p-5 border border-white/10 mt-4">
                                                        <div className="flex items-center gap-2 mb-3">
                                                            <Icons.Check className="w-4 h-4 text-success" />
                                                            <span className="text-[10px] font-bold uppercase text-slate-400 tracking-wider">Improvement Protocol</span>
                                                        </div>
                                                        <ul className="space-y-2">
                                                            {result.advanced.improvements.map((tip, index) => (
                                                                <li key={index} className="flex items-start gap-2 text-xs text-slate-300 leading-relaxed">
                                                                    <span className="text-accent mt-1">â€¢</span>
                                                                    <span>{tip}</span>
                                                                </li>
                                                            ))}
                                                        </ul>
                                                    </div>
                                                )}

                                            </div>
                                        </div>

                                        {/* Fixed Bottom Action Bar */}
                                        <div className="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black via-black/95 to-transparent z-20">
                                            <div className="grid grid-cols-2 gap-4">
                                                <button onClick={() => {setImage(null); setResult(null);}} className="py-3.5 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl font-bold text-xs uppercase tracking-wider text-slate-300 flex items-center justify-center gap-2 backdrop-blur-md transition-all">
                                                    <Icons.Refresh className="w-4 h-4"/> Restart
                                                </button>
                                                <button onClick={() => alert("Image saved to gallery")} className="py-3.5 bg-white text-black hover:bg-slate-200 rounded-xl font-bold text-xs uppercase tracking-wider flex items-center justify-center gap-2 shadow-[0_0_20px_rgba(255,255,255,0.2)] transition-all">
                                                    <Icons.Share className="w-4 h-4"/> Share Report
                                                </button>
                                            </div>
                                        </div>

                                    </div>
                                )}

                                {/* Init State (Image loaded, no result yet) */}
                                {!result && !isAnalyzing && !error && (
                                    <div className="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black via-black/80 to-transparent z-20">
                                        <button onClick={startAnalysis} className="w-full py-4 bg-white text-black rounded-xl font-bold text-sm uppercase tracking-widest shadow-[0_0_30px_rgba(255,255,255,0.15)] flex items-center justify-center gap-2 hover:scale-[1.02] transition-transform">
                                            <Icons.Zap className="fill-black w-5 h-5"/> Initiate Scan
                                        </button>
                                    </div>
                                )}
                            </div>
                        ) : (
                            /* LANDING PAGE (Empty State) */
                            !showCamera && (
                                <div className="flex-1 flex flex-col items-center justify-center p-8 text-center">
                                    
                                    {/* Hero Graphic */}
                                    <div className="relative w-40 h-40 mb-8 flex items-center justify-center">
                                        <div className="absolute inset-0 border border-accent/20 rounded-full animate-[custom-spin_10s_linear_infinite]"></div>
                                        <div className="absolute inset-4 border border-white/10 rounded-full animate-[custom-spin_15s_linear_infinite_reverse]"></div>
                                        <div className="absolute inset-0 bg-accent/5 blur-2xl rounded-full"></div>
                                        <Icons.Scan className="w-12 h-12 text-accent drop-shadow-[0_0_10px_rgba(139,92,246,0.5)]" />
                                    </div>

                                    <h1 className="text-3xl font-bold text-white mb-3 tracking-tight">Biometric Aesthetics</h1>
                                    <p className="text-sm text-slate-400 mb-10 max-w-[260px] leading-relaxed">
                                        Advanced AI analysis of facial symmetry, topology, and dermatological health.
                                    </p>
                                    
                                    <div className="w-full max-w-xs space-y-4">
                                        <button onClick={async () => {
                                            setShowCamera(true);
                                            try { videoRef.current.srcObject = await navigator.mediaDevices.getUserMedia({video:true}); } 
                                            catch(e) { alert("Camera Access Denied"); setShowCamera(false); }
                                        }} className="w-full py-4 bg-gradient-to-r from-violet-600 to-indigo-600 hover:from-violet-500 hover:to-indigo-500 rounded-xl font-bold text-xs uppercase tracking-widest shadow-lg shadow-violet-900/20 flex items-center justify-center gap-2 transition-all group">
                                            <Icons.Camera className="w-5 h-5 group-hover:scale-110 transition-transform"/> Open Camera
                                        </button>
                                        
                                        <div className="relative group">
                                            <div className="absolute inset-0 bg-white/5 rounded-xl transition-opacity group-hover:bg-white/10"></div>
                                            <button className="relative w-full py-4 border border-white/10 rounded-xl font-bold text-xs uppercase tracking-widest text-slate-300 flex items-center justify-center gap-2">
                                                <Icons.Upload className="w-5 h-5"/> Upload Photo
                                            </button>
                                            <input type="file" accept="image/*" onChange={(e) => {
                                                if(e.target.files[0]) {
                                                    const r = new FileReader();
                                                    r.onload = () => setImage(r.result);
                                                    r.readAsDataURL(e.target.files[0]);
                                                }
                                            }} className="absolute inset-0 opacity-0 cursor-pointer" />
                                        </div>
                                    </div>

                                    <div className="mt-8 flex items-center gap-2 opacity-50">
                                        <Icons.Shield className="w-3 h-3 text-slate-500" />
                                        <span className="text-[10px] text-slate-500 uppercase tracking-widest">Private & Secure Analysis</span>
                                    </div>
                                </div>
                            )
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MainApp />);
    </script>
</body>
</html>